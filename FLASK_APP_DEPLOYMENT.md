# Flask App Deployment Guide

This guide provides instructions for deploying the Risk Predictor Flask app in a production environment.

## Overview

The Risk Predictor Flask app needs to be deployed to a server that can be accessed by the main Brain Hack website. This guide covers the necessary steps to deploy the Flask app and configure it to work with the production website.

## Prerequisites

- A server with Python 3.7+ installed
- Access to the production domain where the Brain Hack website is hosted
- Ability to set environment variables on the server

## Deployment Options

### Option 1: Traditional Deployment (Recommended)

#### 1. Clone the Repository

```bash
git clone <repository-url>
cd brain_hack
```

#### 2. Install Dependencies

```bash
cd flask_app
pip install -r requirements.txt
```

### 3. Set Environment Variables

Set the following environment variables on your server:

```bash
# Set the allowed origins for CORS
# Include the production domain of your Brain Hack website
export ALLOWED_ORIGINS="http://localhost:9002,http://localhost:3000,https://your-production-domain.com"

# Optional: Set the port for the Flask app (default is 5000)
export FLASK_PORT=5000

# Set the environment (development or production)
# In production, set this to 'production' to disable debug mode
export FLASK_ENV=production
```

### 4. Configure the Next.js Frontend

In your Next.js application, set the environment variable to point to your Flask API:

```bash
# In your .env.production file or server environment
NEXT_PUBLIC_FLASK_API_URL=https://your-flask-api-domain.com/predict
```

**Important Note for Static Exports:**
The Brain Hack application is configured as a static export (using `next export`). In this configuration:

1. Relative API URLs like '/api/predict' will not work
2. You must set the NEXT_PUBLIC_FLASK_API_URL environment variable to an absolute URL
3. The .env.production file must be updated before building the application

To update the .env.production file:

```bash
# Edit the .env.production file
nano .env.production

# Update the NEXT_PUBLIC_FLASK_API_URL variable with your actual Flask API URL
NEXT_PUBLIC_FLASK_API_URL=https://your-actual-flask-api-domain.com/predict
```

Then rebuild and redeploy the Next.js application:

```bash
npm run build
# Deploy the 'out' directory to your hosting provider
```

### 5. Run the Flask App

For development or testing:

```bash
python app.py
```

For production, it's recommended to use a production WSGI server like Gunicorn:

```bash
pip install gunicorn
gunicorn -w 4 -b 0.0.0.0:5000 app:app
```

### 6. Set Up a Reverse Proxy (Recommended)

For production, it's recommended to set up a reverse proxy (like Nginx) to handle requests to your Flask app:

```nginx
server {
    listen 80;
    server_name your-flask-api-domain.com;

    location / {
        proxy_pass http://localhost:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 7. Set Up SSL (Recommended)

For production, it's recommended to set up SSL to secure the communication between the frontend and backend:

```bash
# Using Let's Encrypt
sudo apt-get install certbot python3-certbot-nginx
sudo certbot --nginx -d your-flask-api-domain.com
```

## Alternative: API Gateway Setup

If you're using an API gateway or a serverless architecture, you can set up a proxy endpoint that forwards requests to your Flask app:

1. Create a new API endpoint in your API gateway
2. Configure it to forward requests to your Flask app
3. Update the `NEXT_PUBLIC_FLASK_API_URL` environment variable to point to this endpoint

## Troubleshooting

- If you're seeing CORS errors, make sure the production domain is included in the `ALLOWED_ORIGINS` environment variable
- If the Flask app is not receiving requests, check that the port is open and accessible from the frontend
- If the frontend is not connecting to the Flask app, check that the `NEXT_PUBLIC_FLASK_API_URL` environment variable is set correctly

### Flask and Werkzeug Compatibility

If you encounter an error like this when running the Flask app:

```
ImportError: cannot import name 'url_quote' from 'werkzeug.urls'
```

This is due to a compatibility issue between Flask and Werkzeug versions. We've updated the requirements.txt file to specify Werkzeug 2.0.1, which is compatible with Flask 2.0.1.

Make sure to install the correct version of Werkzeug:

```bash
pip install werkzeug==2.0.1
```

### XGBoost Model Warning

If you see a warning about XGBoost model serialization:

```
WARNING: If you are loading a serialized model (like pickle in Python, RDS in R) or
configuration generated by an older version of XGBoost, please export the model by calling
`Booster.save_model` from that version first, then load it back in current version.
```

We've updated the app.py file to handle this warning. The code includes a commented section that can be uncommented to convert the model to XGBoost's native format:

1. Open app.py and find the model loading section
2. Uncomment the code block that converts the model to XGBoost's native format
3. Restart the application

This will save the model in XGBoost's native format and reload it, which should eliminate the warning.

### Numpy and Scikit-learn Version Compatibility

If you encounter an error like this when loading the model:

```
ModuleNotFoundError: No module named 'numpy._core'
```

Or warnings about scikit-learn version mismatches:

```
UserWarning: Trying to unpickle estimator StandardScaler from version 1.6.1 when using version 0.24.2. This might lead to breaking code or invalid results.
```

This is due to a compatibility issue between the versions of numpy and scikit-learn used to create the model and the versions installed. We've updated the requirements.txt file to specify compatible versions:

- numpy==1.24.0
- scikit-learn==1.6.1

Make sure to install the correct versions:

```bash
pip install numpy==1.24.0 scikit-learn==1.6.1
```

If you need to use different versions for some reason, you may need to retrain the model using those specific versions.

## Monitoring and Logging

For production, it's recommended to set up monitoring and logging:

```bash
# Install monitoring tools
pip install prometheus_client
pip install flask_prometheus_metrics

# Set up logging
export LOG_LEVEL=INFO
export LOG_FILE=/var/log/flask_app.log
```

## Security Considerations

- Ensure that your Flask app is not running in debug mode in production
- Consider implementing rate limiting to prevent abuse
- Regularly update dependencies to patch security vulnerabilities
- Use environment variables for sensitive configuration (don't hardcode in the app)
